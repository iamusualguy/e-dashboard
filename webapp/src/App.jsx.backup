import React, { useEffect, useState } from "react";

export default function App() {
  const [fromStation, setFromStation] = useState(
    () => sessionStorage.getItem("fromStation") || "",
  );
  const [toStation, setToStation] = useState(
    () => sessionStorage.getItem("toStation") || "",
  );
  const [fromStationCode, setFromStationCode] = useState(
    () => sessionStorage.getItem("fromStationCode") || "",
  );
  const [toStationCode, setToStationCode] = useState(
    () => sessionStorage.getItem("toStationCode") || "",
  );
  const [fromStations, setFromStations] = useState([]);
  const [toStations, setToStations] = useState([]);
  const [showFromDropdown, setShowFromDropdown] = useState(false);
  const [showToDropdown, setShowToDropdown] = useState(false);
  const [trips, setTrips] = useState([]);
  const [loadingTrips, setLoadingTrips] = useState(false);
  const [onlyTrains, setOnlyTrains] = useState(true);
  const backendUrl =
    import.meta.env.VITE_BACKEND_URL || "http://localhost:3000";

  async function searchStations(query, setStations) {
    if (query.length < 2) {
      setStations([]);
      return;
    }
    try {
      const res = await fetch(
        `${backendUrl}/stations?q=${encodeURIComponent(query)}&limit=10`,
      );
      const result = await res.json();
      setStations(result.stations || []);
    } catch (e) {
      console.error("Error searching stations:", e);
      setStations([]);
    }
  }

  async function searchTrips() {
    if (!fromStationCode || !toStationCode) return;

    setLoadingTrips(true);
    try {
      const res = await fetch(
        `${backendUrl}/trips?fromStation=${encodeURIComponent(fromStationCode)}&toStation=${encodeURIComponent(toStationCode)}`,
      );
      const result = await res.json();
      setTrips(result.trips || []);
    } catch (e) {
      console.error("Error searching trips:", e);
      setTrips([]);
    } finally {
      setLoadingTrips(false);
    }
  }

  function handleFromChange(e) {
    const value = e.target.value;
    setFromStation(value);
    searchStations(value, setFromStations);
    setShowFromDropdown(true);
  }

  function handleToChange(e) {
    const value = e.target.value;
    setToStation(value);
    searchStations(value, setToStations);
    setShowToDropdown(true);
  }

  function selectFromStation(station) {
    setFromStation(station.name);
    setFromStationCode(station.code);
    sessionStorage.setItem("fromStation", station.name);
    sessionStorage.setItem("fromStationCode", station.code);
    setShowFromDropdown(false);
  }

  function selectToStation(station) {
    setToStation(station.name);
    setToStationCode(station.code);
    sessionStorage.setItem("toStation", station.name);
    sessionStorage.setItem("toStationCode", station.code);
    setShowToDropdown(false);
  }

  useEffect(() => {
    if (fromStationCode && toStationCode) {
      searchTrips();
    }
  }, [fromStationCode, toStationCode]);

  if (loadingTrips && trips.length === 0) return <p>Loading...</p>;

  return (
    <div
      style={{
        fontFamily: '"Helvetica Neue", Arial, sans-serif',
        maxWidth: "1200px",
        margin: "0 auto",
        padding: "40px 20px",
        backgroundColor: "#f5f5f5",
      }}
    >
      <style>{`
        th {
          padding: 12px;
          text-align: left;
          border-bottom: 2px solid #000;
          font-weight: 700;
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 1px;
          background-color: #878787;
        }
      `}</style>

      <h1
        style={{
          fontSize: "48px",
          fontWeight: "900",
          letterSpacing: "-2px",
          margin: "0 0 40px 0",
          color: "#000",
          textTransform: "uppercase",
        }}
      >
        NS Reisplanner
      </h1>

      <div
        style={{
          backgroundColor: "#fff",
          border: "3px solid #000",
          padding: "30px",
          marginBottom: "30px",
        }}
      >
        <div style={{ display: "flex", gap: "20px", marginBottom: "20px" }}>
          <div style={{ position: "relative", flex: 1 }}>
            <label
              style={{
                display: "block",
                marginBottom: "8px",
                fontWeight: "700",
                fontSize: "12px",
                textTransform: "uppercase",
                letterSpacing: "1px",
                color: "#000",
              }}
            >
              Van
            </label>
            <input
              type="text"
              value={fromStation}
              onChange={handleFromChange}
              onFocus={() => setShowFromDropdown(true)}
              placeholder="Zoek vertrekstation..."
              style={{
                width: "100%",
                padding: "12px",
                fontSize: "16px",
                border: "2px solid #000",
                backgroundColor: "#fff",
                fontFamily: "inherit",
              }}
            />
            {showFromDropdown && fromStations.length > 0 && (
              <div
                style={{
                  position: "absolute",
                  top: "100%",
                  left: 0,
                  right: 0,
                  backgroundColor: "#fff",
                  border: "2px solid #000",
                  borderTop: "none",
                  maxHeight: "200px",
                  overflowY: "auto",
                  zIndex: 1000,
                }}
              >
                {fromStations.map((station) => (
                  <div
                    key={station.code}
                    onClick={() => selectFromStation(station)}
                    style={{
                      padding: "12px",
                      cursor: "pointer",
                      borderBottom: "1px solid #ddd",
                      backgroundColor: "#fff",
                    }}
                    onMouseEnter={(e) => {
                      e.target.style.backgroundColor = "#000";
                      e.target.style.color = "#fff";
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = "#fff";
                      e.target.style.color = "#000";
                    }}
                  >
                    {station.name} ({station.code})
                  </div>
                ))}
              </div>
            )}
          </div>

          <div style={{ position: "relative", flex: 1 }}>
            <label
              style={{
                display: "block",
                marginBottom: "8px",
                fontWeight: "700",
                fontSize: "12px",
                textTransform: "uppercase",
                letterSpacing: "1px",
                color: "#000",
              }}
            >
              Naar
            </label>
            <input
              type="text"
              value={toStation}
              onChange={handleToChange}
              onFocus={() => setShowToDropdown(true)}
              placeholder="Zoek aankomststation..."
              style={{
                width: "100%",
                padding: "12px",
                fontSize: "16px",
                border: "2px solid #000",
                backgroundColor: "#fff",
                fontFamily: "inherit",
              }}
            />
            {showToDropdown && toStations.length > 0 && (
              <div
                style={{
                  position: "absolute",
                  top: "100%",
                  left: 0,
                  right: 0,
                  backgroundColor: "#fff",
                  border: "2px solid #000",
                  borderTop: "none",
                  maxHeight: "200px",
                  overflowY: "auto",
                  zIndex: 1000,
                }}
              >
                {toStations.map((station) => (
                  <div
                    key={station.code}
                    onClick={() => selectToStation(station)}
                    style={{
                      padding: "12px",
                      cursor: "pointer",
                      borderBottom: "1px solid #ddd",
                      backgroundColor: "#fff",
                    }}
                    onMouseEnter={(e) => {
                      e.target.style.backgroundColor = "#000";
                      e.target.style.color = "#fff";
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = "#fff";
                      e.target.style.color = "#000";
                    }}
                  >
                    {station.name} ({station.code})
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        <button
          onClick={searchTrips}
          disabled={!fromStationCode || !toStationCode || loadingTrips}
          style={{
            padding: "15px 30px",
            fontSize: "14px",
            fontWeight: "700",
            textTransform: "uppercase",
            letterSpacing: "1px",
            backgroundColor: fromStationCode && toStationCode ? "#000" : "#ccc",
            color: "#fff",
            border: "none",
            cursor:
              fromStationCode && toStationCode ? "pointer" : "not-allowed",
            fontFamily: "inherit",
          }}
        >
          {loadingTrips ? "Zoeken..." : "Zoek Reizen"}
        </button>

        <label
          style={{
            display: "flex",
            alignItems: "center",
            gap: "10px",
            marginTop: "20px",
            cursor: "pointer",
            userSelect: "none",
            fontSize: "14px",
            fontWeight: "500",
          }}
        >
          <input
            type="checkbox"
            checked={onlyTrains}
            onChange={(e) => setOnlyTrains(e.target.checked)}
            style={{
              cursor: "pointer",
              width: "18px",
              height: "18px",
            }}
          />
          <span>Alleen treinen (NS Sprinter & Intercity)</span>
        </label>
      </div>

      {trips.length > 0 && (
        <div>
          <h2
            style={{
              fontSize: "24px",
              fontWeight: "700",
              textTransform: "uppercase",
              letterSpacing: "1px",
              marginBottom: "20px",
              color: "#000",
            }}
          >
            Reismogelijkheden
          </h2>
          {trips.map((trip, idx) => {
            const totalDuration =
              trip.actualDurationInMinutes || trip.plannedDurationInMinutes;
            const firstLeg = trip.legs[0];
            const lastLeg = trip.legs[trip.legs.length - 1];
            const departureTime = new Date(
              firstLeg?.actualDeparture || firstLeg?.plannedDeparture,
            );
            const arrivalTime = new Date(
              lastLeg?.actualArrival || lastLeg?.plannedArrival,
            );

            return (
              <div
                key={trip.uid || idx}
                style={{
                  border: "3px solid #000",
                  marginBottom: "30px",
                  backgroundColor: "#fff",
                }}
              >
                <div
                  style={{
                    backgroundColor: "#000",
                    color: "#fff",
                    padding: "15px 20px",
                    fontWeight: "700",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    fontSize: "18px",
                    letterSpacing: "0.5px",
                  }}
                >
                  <span>
                    {departureTime.toLocaleTimeString("nl-NL", {
                      hour: "2-digit",
                      minute: "2-digit",
                      hour12: false,
                    })}{" "}
                    →{" "}
                    {arrivalTime.toLocaleTimeString("nl-NL", {
                      hour: "2-digit",
                      minute: "2-digit",
                      hour12: false,
                    })}
                  </span>
                  <span style={{ fontSize: "14px", fontWeight: "500" }}>
                    {totalDuration} min | {trip.transfers} overstap
                    {trip.transfers !== 1 ? "pen" : ""}
                  </span>
                </div>

                <table style={{ width: "100%", borderCollapse: "collapse" }}>
                  <thead>
                    <tr>
                      <th>Tijd</th>
                      <th>Station</th>
                      <th>Spoor</th>
                      <th>Trein</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {trip.legs
                      .filter(
                        (leg) =>
                          !onlyTrains ||
                          (leg.product &&
                            (leg.product.includes("Sprinter") ||
                              leg.product.includes("Intercity"))),
                      )
                      .map((leg, legIdx, filteredLegs) => {
                        const depTime = new Date(
                          leg.actualDeparture || leg.plannedDeparture,
                        );
                        const arrTime = new Date(
                          leg.actualArrival || leg.plannedArrival,
                        );
                        const delayed =
                          leg.actualDeparture &&
                          leg.plannedDeparture &&
                          new Date(leg.actualDeparture) >
                            new Date(leg.plannedDeparture);

                        return (
                          <React.Fragment key={legIdx}>
                            <tr
                              style={{
                                backgroundColor: leg.cancelled
                                  ? "#d0d0d0"
                                  : "#fff",
                              }}
                            >
                              <td
                                style={{
                                  padding: "12px",
                                  borderBottom: "1px solid #ccc",
                                  fontWeight: "700",
                                  fontSize: "16px",
                                }}
                              >
                                {depTime.toLocaleTimeString("nl-NL", {
                                  hour: "2-digit",
                                  minute: "2-digit",
                                  hour12: false,
                                })}
                                {delayed && (
                                  <span
                                    style={{
                                      marginLeft: "5px",
                                      fontSize: "12px",
                                    }}
                                  >
                                    ▲
                                  </span>
                                )}
                              </td>
                              <td
                                style={{
                                  padding: "12px",
                                  borderBottom: "1px solid #ccc",
                                  fontSize: "15px",
                                }}
                              >
                                {leg.origin}
                              </td>
                              <td
                                style={{
                                  padding: "12px",
                                  borderBottom: "1px solid #ccc",
                                }}
                              >
                                <span
                                  style={{
                                    fontWeight: "700",
                                    fontSize: "16px",
                                    textDecoration: leg.departurePlatformChanged
                                      ? "underline"
                                      : "none",
                                  }}
                                >
                                  {leg.departureTrack || "—"}
                                </span>
                                {leg.departurePlatformChanged && (
                                  <span
                                    style={{
                                      fontSize: "11px",
                                      marginLeft: "4px",
                                    }}
                                  >
                                    gewijzigd
                                  </span>
                                )}
                              </td>
                              <td
                                style={{
                                  padding: "12px",
                                  borderBottom: "1px solid #ccc",
                                }}
                                rowSpan={2}
                              >
                                <div
                                  style={{
                                    fontWeight: "700",
                                    fontSize: "14px",
                                  }}
                                >
                                  {leg.product || "Lopen"}
                                </div>
                                <div
                                  style={{
                                    fontSize: "12px",
                                    color: "#666",
                                    marginTop: "2px",
                                  }}
                                >
                                  → {leg.destination}
                                </div>
                              </td>
                              <td
                                style={{
                                  padding: "12px",
                                  borderBottom: "1px solid #ccc",
                                  fontSize: "13px",
                                  fontWeight: "600",
                                }}
                                rowSpan={2}
                              >
                                {leg.cancelled ? (
                                  <span>✕ GEANNULEERD</span>
                                ) : delayed ? (
                                  <span>▲ Vertraagd</span>
                                ) : (
                                  <span>✓ Op tijd</span>
                                )}
                              </td>
                            </tr>
                            <tr
                              style={{
                                backgroundColor: leg.cancelled
                                  ? "#d0d0d0"
                                  : "#fff",
                              }}
                            >
                              <td
                                style={{
                                  padding: "12px",
                                  borderBottom:
                                    legIdx < filteredLegs.length - 1
                                      ? "3px solid #000"
                                      : "1px solid #ccc",
                                  fontWeight: "700",
                                  fontSize: "16px",
                                }}
                              >
                                {arrTime.toLocaleTimeString("nl-NL", {
                                  hour: "2-digit",
                                  minute: "2-digit",
                                  hour12: false,
                                })}
                              </td>
                              <td
                                style={{
                                  padding: "12px",
                                  borderBottom:
                                    legIdx < filteredLegs.length - 1
                                      ? "3px solid #000"
                                      : "1px solid #ccc",
                                  fontSize: "15px",
                                }}
                              >
                                {leg.destination}
                              </td>
                              <td
                                style={{
                                  padding: "12px",
                                  borderBottom:
                                    legIdx < filteredLegs.length - 1
                                      ? "3px solid #000"
                                      : "1px solid #ccc",
                                }}
                              >
                                <span
                                  style={{
                                    fontWeight: "700",
                                    fontSize: "16px",
                                    textDecoration: leg.arrivalPlatformChanged
                                      ? "underline"
                                      : "none",
                                  }}
                                >
                                  {leg.arrivalTrack || "—"}
                                </span>
                                {leg.arrivalPlatformChanged && (
                                  <span
                                    style={{
                                      fontSize: "11px",
                                      marginLeft: "4px",
                                    }}
                                  >
                                    gewijzigd
                                  </span>
                                )}
                              </td>
                            </tr>
                          </React.Fragment>
                        );
                      })}
                  </tbody>
                </table>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
